service:
- docker
group: trusty_lts
env:
  global:
    TERM=dumb
language: java
jdk:
  - openjdk8
  - oraclejdk8
install: true
before_install:
# install docker-compose
- sudo apt update -y || true
- sudo apt install -y --no-install-recommends docker-ce python-pip curl jq libxml2-utils
- sudo pip install docker-compose httpie
# kill on ports
- source <(curl -s https://raw.githubusercontent.com/daggerok/bash-functions/master/main.bash)
- stop_any 5432 5672 27017 3000 8000 8080 80 27017 5672 5432
script:
- export ROOT=$PWD
## gitbbok
- cd $ROOT/gitbbok
- bash gradlew clean buildDocs
# all
- >
  for path in \
    spring-integration-5-example-02 \
    spring-integration-5-example-01 \
  ; do
    export TARGET="$ROOT/$path"
    cd $TARGET
    bash gradlew clean build
  done;

# 01 e2e
- cd $ROOT/spring-integration-5-example-01
- bash gradlew clean build
- sudo mkdir -p /var/app
- sudo mv -f ./build/libs/*.jar /var/app/01.jar
- sudo ln -s /var/app/01.jar /etc/init.d/01
- sudo service 01 start
- sleep 15
- curl localhost:8080/sse &
- sleep 1
- sudo service 01 stop

after_script:
- bash gradlew --stop

cache:
  directories:
  - docs/
  - gitbook/node_modules/
